<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Backup no Google Drive</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="manifest" href="manifest.json"/>

  <!-- PRÉ-CARREGAR as bibliotecas (evita perder o gesto do usuário) -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; }
    header { display:flex; align-items:center; gap:12px; padding:12px 16px; background:#1e88e5; color:#fff; }
    main { padding:16px; max-width:680px; margin:0 auto; }
    .card { background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:16px; }
    button { width:100%; padding:12px; font-size:16px; border:0; border-radius:10px; cursor:pointer; }
    #auth { background:#1e88e5; color:#fff; }
    #revoke { background:#ef5350; color:#fff; margin-top:10px; display:none; }
    #status { margin-top:16px; text-align:center; font-weight:600; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:18px;">Backup no Google Drive</h1>
  </header>

  <main>
    <section class="card">
      <h2 style="margin-top:0;">Salvar Backup na Nuvem</h2>
      <p>Clique para autorizar e salvar seus dados na pasta <b>"Backup MF Orçamento"</b> no seu Drive.</p>

      <button id="auth">Autorizar e Fazer Backup</button>
      <button id="revoke">Desconectar / Revogar Acesso</button>

      <div id="status">Pronto para iniciar.</div>
    </section>
  </main>

  <script>
    // ======= CONFIG =======
    const CLIENT_ID = '665704691318-r51olsj24q86sb8htcho1eaj0v583af8.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const FOLDER_NAME = "Backup MF Orçamento";

    // ======= ELEMENTOS =======
    const btnAuth = document.getElementById('auth');
    const btnRevoke = document.getElementById('revoke');
    const statusDiv = document.getElementById('status');

    // ======= ESTADO =======
    let tokenClient;
    let gapiReady = false;
    let gisReady = false;
    let isAuthorized = false;

    statusDiv.textContent = 'Pronto para iniciar.';

    // ======= INIT GAPI =======
    window.addEventListener('load', () => {
      gapi.load('client', async () => {
        try {
          await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
          gapiReady = true;
        } catch (e) {
          console.error('Falha init gapi:', e);
          statusDiv.textContent = 'Erro ao carregar Google API.';
        }
      });
    });

    // ======= INIT GIS (Token Flow + FedCM) =======
    window.addEventListener('load', () => {
      try {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          // FedCM ajuda no PWA com cookies de 3ª parte bloqueados
          use_fedcm_for_prompt: true,
          callback: (response) => {
            btnAuth.disabled = false;

            if (response.error) {
              console.error(response.error);
              statusDiv.textContent = 'Erro de autorização. Tente novamente.';
              return;
            }

            // >>> ESSENCIAL: aplica o token ao gapi <<<
            gapi.client.setToken({ access_token: response.access_token });

            isAuthorized = true;
            btnRevoke.style.display = 'block';
            btnAuth.textContent = 'Fazer Novo Backup';
            statusDiv.textContent = 'Autorizado! Clique novamente para fazer o backup.';
          },
        });
        gisReady = true;
      } catch (e) {
        console.error('Falha init GIS:', e);
        statusDiv.textContent = 'Erro ao carregar Google Identity.';
      }
    });

    // ======= CLIQUE (gesto do usuário) =======
    btnAuth.addEventListener('click', async () => {
      if (!(gapiReady && gisReady)) {
        statusDiv.textContent = 'Carregando bibliotecas do Google...';
        btnAuth.disabled = true;
        setTimeout(() => { btnAuth.disabled = false; }, 1200);
        return;
      }

      if (!isAuthorized) {
        // Solicitar token DENTRO do clique (evita bloqueio em PWA)
        statusDiv.textContent = 'Pedindo autorização...';
        btnAuth.disabled = true;
        // prompt:'' evita reconsent desnecessário e funciona melhor com FedCM
        tokenClient.requestAccessToken({ prompt: '' });
        return;
      }

      // Já autorizado → executa backup
      backupDataToDrive();
    });

    // ======= REVOGAR =======
    btnRevoke.addEventListener('click', () => {
      const tok = gapi.client.getToken();
      if (!tok || !tok.access_token) return;

      google.accounts.oauth2.revoke(tok.access_token, () => {
        gapi.client.setToken('');
        isAuthorized = false;
        btnRevoke.style.display = 'none';
        btnAuth.textContent = 'Autorizar e Fazer Backup';
        statusDiv.textContent = 'Acesso revogado.';
      });
    });

    // ======= BACKUP =======
    async function backupDataToDrive() {
      try {
        statusDiv.textContent = 'Procurando/CRIANDO pasta de backup...';
        const folderId = await findOrCreateFolder();
        if (!folderId) return;

        statusDiv.textContent = 'Preparando os dados...';
        const backupData = collectBackupData();

        const ts = new Date().toISOString().slice(0,19).replace('T','_').replace(/:/g,'-');
        const uniqueFileName = `backup-orcamento-${ts}.json`;

        const fileMetadata = { name: uniqueFileName, parents: [folderId], mimeType: 'application/json' };

        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        const multipartRequestBody =
          delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
          JSON.stringify(fileMetadata) +
          delimiter + 'Content-Type: application/json\r\n\r\n' +
          backupData + close_delim;

        statusDiv.textContent = 'Enviando arquivo ao Drive...';

        const response = await gapi.client.request({
          path: 'https://www.googleapis.com/upload/drive/v3/files',
          method: 'POST',
          params: { uploadType: 'multipart' },
          headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
          body: multipartRequestBody
        });

        if (response.status === 200 && response.result) {
          statusDiv.textContent = `Backup "${response.result.name}" realizado com sucesso!`;
        } else {
          statusDiv.textContent = 'Erro: a API não confirmou a criação do arquivo.';
          console.error('Resposta inesperada:', response);
        }
      } catch (error) {
        const msg = error?.result?.error?.message || error.message || String(error);
        statusDiv.textContent = 'Erro durante o backup: ' + msg;
        console.error('Erro no backup:', error);
      }
    }

    function collectBackupData() {
      const transactions = localStorage.getItem('transactions');
      const categories = localStorage.getItem('categories');
      const accounts = localStorage.getItem('accounts');
      const allData = {
        transactions: JSON.parse(transactions) || [],
        categories: JSON.parse(categories) || { despesas: [], receitas: [] },
        accounts: JSON.parse(accounts) || [],
        lastBackup: new Date().toISOString(),
      };
      return JSON.stringify(allData, null, 2);
    }

    async function findOrCreateFolder() {
      try {
        // Procurar pasta
        let resp = await gapi.client.drive.files.list({
          q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
          fields: 'files(id,name)'
        });
        if (resp.result.files?.length) return resp.result.files[0].id;

        // Criar pasta
        statusDiv.textContent = 'Pasta não encontrada. Criando...';
        resp = await gapi.client.drive.files.create({
          resource: { name: FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' },
          fields: 'id'
        });
        return resp.result.id;
      } catch (e) {
        const msg = e?.result?.error?.message || e.message || String(e);
        statusDiv.textContent = 'Erro ao procurar/criar pasta: ' + msg;
        console.error('findOrCreateFolder:', e);
        return null;
      }
    }
  </script>
</body>
</html>

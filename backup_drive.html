<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Backup no Google Drive</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="manifest" href="manifest.json"/>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; }
    header { display:flex; align-items:center; gap:12px; padding:12px 16px; background:#1e88e5; color:#fff; }
    main { padding:16px; max-width:680px; margin:0 auto; }
    .card { background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:16px; }
    button { width:100%; padding:12px; font-size:16px; border:0; border-radius:10px; cursor:pointer; }
    #auth { background:#1e88e5; color:#fff; }
    #revoke { background:#ef5350; color:#fff; margin-top:10px; display:none; }
    #status { margin-top:16px; text-align:center; font-weight:600; }
  </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-container">
            <img src="icon-192.png" alt="Ícone do App" style="width: 80px; margin-bottom: 20px;">
            <h2 id="auth-title">Acesso Restrito</h2>
            <p id="auth-message">Por favor, digite sua senha para continuar.</p>
            <div class="auth-inputs">
                <input type="password" id="password-input" placeholder="Senha">
                <input type="password" id="password-confirm-input" placeholder="Confirme a Senha" style="display: none;">
            </div>
             <div class="forgot-password-container" style="display: none;">
                 <a href="#" id="forgot-password-link">Esqueceu a senha?</a>
            </div>
             <p id="auth-error" style="color: #c62828; display: none; margin-top: 10px;"></p>
            <button id="auth-button">Entrar</button>
        </div>
    </div>

  <header>
    <a href="index.html" style="color: white; text-decoration: none; font-size: 1.5em;"> &larr; </a>
    <h1 style="margin:0;font-size:18px;">Backup no Google Drive</h1>
  </header>

  <main>
    <section class="card">
      <h2 style="margin-top:0;">Salvar Backup na Nuvem</h2>
      <p>Clique para autorizar e salvar seus dados na pasta <b>"Backup MF Orçamento"</b> no seu Drive.</p>

      <button id="auth">Autorizar e Fazer Backup</button>
      <button id="revoke">Desconectar / Revogar Acesso</button>

      <div id="status">Pronto para iniciar.</div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const USER_STORAGE_KEY = 'mf-orcamento-user';
        const loginOverlay = document.getElementById('login-overlay');
        const passwordInput = document.getElementById('password-input');
        const passwordConfirmInput = document.getElementById('password-confirm-input');
        const authButton = document.getElementById('auth-button');
        const authTitle = document.getElementById('auth-title');
        const authMessage = document.getElementById('auth-message');
        const authError = document.getElementById('auth-error');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const forgotPasswordContainer = forgotPasswordLink.parentElement;

        function getUserCredentials() {
            return JSON.parse(localStorage.getItem(USER_STORAGE_KEY));
        }

        function handleLogin() {
            const credentials = getUserCredentials();
            if (!credentials) {
                window.location.href = './index.html';
                return;
            }
            if (passwordInput.value === credentials.password) {
                sessionStorage.setItem('isLoggedIn', 'true');
                loginOverlay.style.display = 'none';
                initializeBackupApp(); 
            } else {
                authError.textContent = 'Senha incorreta!';
                authError.style.display = 'block';
                passwordInput.value = '';
            }
        }

        function setupAuthScreen() {
            const credentials = getUserCredentials();
            if (credentials) {
                authTitle.textContent = 'Acesso Restrito';
                authMessage.textContent = 'Por favor, digite sua senha para continuar.';
                passwordConfirmInput.style.display = 'none';
                authButton.textContent = 'Entrar';
                authButton.onclick = handleLogin;
                passwordInput.onkeypress = (e) => { if (e.key === 'Enter') handleLogin(); };
                forgotPasswordContainer.style.display = 'block';
            } else {
                 window.location.href = './index.html';
            }
        }
        
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Tem certeza que deseja resetar sua senha? ATENÇÃO: Isso apagará TODOS os seus dados. Esta ação não pode ser desfeita.')) {
                if (confirm('ÚLTIMO AVISO: Todos os dados serão perdidos. Deseja continuar?')) {
                    localStorage.clear();
                    sessionStorage.clear();
                    alert('Dados apagados. O app será recarregado.');
                    location.reload();
                }
            }
        });

        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            loginOverlay.style.display = 'flex';
            setupAuthScreen();
        } else {
            loginOverlay.style.display = 'none';
            initializeBackupApp();
        }

        function initializeBackupApp() {
            const CLIENT_ID = '665704691318-r51olsj24q86sb8htcho1eaj0v583af8.apps.googleusercontent.com';
            const SCOPES = 'https://www.googleapis.com/auth/drive.file';
            const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
            const FOLDER_NAME = "Backup MF Orçamento";

            const btnAuth = document.getElementById('auth');
            const btnRevoke = document.getElementById('revoke');
            const statusDiv = document.getElementById('status');

            let tokenClient;
            let gapiInited = false;
            let gisInited = false;

            statusDiv.textContent = 'Carregando bibliotecas do Google...';
            btnAuth.disabled = true;

            function gapiLoaded() {
                gapi.load('client', initializeGapiClient);
            }
            async function initializeGapiClient() {
                await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
                maybeEnableButtons();
            }
            function gisLoaded() {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // O callback é tratado na promise
                });
                gisInited = true;
                maybeEnableButtons();
            }
            function maybeEnableButtons() {
                if (gapiInited && gisInited) {
                    statusDiv.textContent = 'Pronto para iniciar.';
                    btnAuth.disabled = false;
                }
            }

            // Carrega os scripts dinamicamente para garantir a ordem
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.onload = gapiLoaded;
            document.body.appendChild(gapiScript);

            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.onload = gisLoaded;
            document.body.appendChild(gisScript);


            btnAuth.addEventListener('click', async () => {
                const token = gapi.client.getToken();
                if (token === null) {
                    // Solicita autorização
                    tokenClient.callback = async (resp) => {
                        if (resp.error !== undefined) {
                            statusDiv.textContent = 'Erro de autorização. Tente novamente.';
                            throw (resp);
                        }
                        btnRevoke.style.display = 'block';
                        btnAuth.textContent = 'Fazer Novo Backup';
                        statusDiv.textContent = 'Autorizado! Clique novamente para fazer o backup.';
                    };
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    // Já autorizado, faz o backup
                    backupDataToDrive();
                }
            });
            
            btnRevoke.addEventListener('click', () => {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        gapi.client.setToken('');
                        btnRevoke.style.display = 'none';
                        btnAuth.textContent = 'Autorizar e Fazer Backup';
                        statusDiv.textContent = 'Acesso revogado.';
                    });
                }
            });
            
            async function backupDataToDrive() {
                try {
                    statusDiv.textContent = 'Procurando/CRIANDO pasta de backup...';
                    const folderId = await findOrCreateFolder();
                    if (!folderId) return;

                    statusDiv.textContent = 'Preparando os dados...';
                    const backupData = collectBackupData();
                    if (!backupData) {
                        statusDiv.textContent = 'Não há dados para fazer backup.';
                        return;
                    }

                    const ts = new Date().toISOString().slice(0,19).replace('T','_').replace(/:/g,'-');
                    const uniqueFileName = `backup-orcamento-${ts}.json`;

                    const fileMetadata = { name: uniqueFileName, parents: [folderId], mimeType: 'application/json' };
                    const boundary = '-------314159265358979323846';
                    const delimiter = "\r\n--" + boundary + "\r\n";
                    const close_delim = "\r\n--" + boundary + "--";
                    const multipartRequestBody =
                        delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                        JSON.stringify(fileMetadata) +
                        delimiter + 'Content-Type: application/json\r\n\r\n' +
                        backupData + close_delim;

                    statusDiv.textContent = 'Enviando arquivo ao Drive...';
                    const response = await gapi.client.request({
                        path: '/upload/drive/v3/files',
                        method: 'POST',
                        params: { uploadType: 'multipart' },
                        headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                        body: multipartRequestBody
                    });

                    if (response.status === 200) {
                        statusDiv.textContent = `Backup "${uniqueFileName}" realizado com sucesso!`;
                    } else {
                        statusDiv.textContent = 'Erro: Falha no envio do arquivo.';
                        console.error('Resposta inesperada:', response);
                    }
                } catch (error) {
                    const msg = error?.result?.error?.message || error.message || String(error);
                    statusDiv.textContent = 'Erro durante o backup: ' + msg;
                    console.error('Erro no backup:', error);
                }
            }

            function collectBackupData() {
                const allData = {};
                let hasData = false;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if(key !== USER_STORAGE_KEY) {
                        allData[key] = JSON.parse(localStorage.getItem(key));
                        hasData = true;
                    }
                }
                if (!hasData) return null;
                 allData.lastBackup = new Date().toISOString();
                return JSON.stringify(allData, null, 2);
            }

            async function findOrCreateFolder() {
                try {
                    let resp = await gapi.client.drive.files.list({
                        q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                        fields: 'files(id,name)'
                    });
                    if (resp.result.files?.length) return resp.result.files[0].id;

                    statusDiv.textContent = 'Pasta não encontrada. Criando...';
                    resp = await gapi.client.drive.files.create({
                        resource: { name: FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' },
                        fields: 'id'
                    });
                    return resp.result.id;
                } catch (e) {
                    const msg = e?.result?.error?.message || e.message || String(e);
                    statusDiv.textContent = 'Erro ao procurar/criar pasta: ' + msg;
                    console.error('findOrCreateFolder:', e);
                    return null;
                }
            }
        }
    });
  </script>
</body>
</html>

